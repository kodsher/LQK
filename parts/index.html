<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parts Search Results</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px;
      min-height: 100vh;
      color: #e9ecef;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #1e1e2f;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      color: #e5e7eb;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .filters {
      background: #252538;
      padding: 25px;
      border-bottom: 2px solid #3a3a4a;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 14px;
    }

    .filter-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-inputs input {
      flex: 1;
      padding: 10px;
      border: 2px solid #3a3a4a;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      background: #1a1a2e;
      color: #e5e7eb;
    }

    .filter-inputs input:focus {
      outline: none;
      border-color: #ef4444;
    }

    #searchInput {
      width: 100%;
      padding: 10px;
      border: 2px solid #3a3a4a;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      background: #1a1a2e;
      color: #e5e7eb;
    }

    #searchInput:focus {
      outline: none;
      border-color: #ef4444;
    }

    .filter-separator {
      color: #adb5bd;
      font-weight: 500;
    }

    .stats {
      display: flex;
      gap: 30px;
      justify-content: center;
      padding: 15px;
      background: #1a1a2e;
      border-radius: 8px;
      margin-top: 15px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #e5e7eb;
    }

    .stat-label {
      font-size: 12px;
      color: #adb5bd;
      margin-top: 5px;
    }

    .table-container {
      padding: 25px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e1e2f;
    }

    thead {
      background: #252538;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #e5e7eb;
      border-bottom: 2px solid #3a3a4a;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }

    th:hover {
      background: #2a2a40;
    }

    th.sort-asc::after {
      content: ' â–²';
      font-size: 12px;
    }

    th.sort-desc::after {
      content: ' â–¼';
      font-size: 12px;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid #3a3a4a;
      font-size: 14px;
      color: #e5e7eb;
    }

    tbody tr:hover {
      background: #252538;
    }

    tbody tr {
      cursor: pointer;
    }

    .percentage {
      font-weight: 600;
    }

    .percentage.high {
      color: #4ade80;
    }

    .percentage.medium {
      color: #fbbf24;
    }

    .percentage.low {
      color: #f87171;
    }

    .sold-count {
      font-weight: 600;
      color: #e5e7eb;
    }

    .delete-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
    }

    .delete-btn:hover {
      background: #b91c1c;
    }

    .delete-btn:active {
      transform: scale(0.95);
    }

    .delete-btn:disabled {
      background: #6b7280;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .price-input {
      width: 120px;
      padding: 8px 10px;
      border: 2px solid #3a3a4a;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      background: #1a1a2e;
      color: #e5e7eb;
    }

    .price-input:focus {
      outline: none;
      border-color: #ef4444;
    }

    .price-input:hover {
      border-color: #4a4a5a;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #adb5bd;
      font-size: 18px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #adb5bd;
      font-size: 18px;
    }

    .reset-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 15px;
    }

    .reset-btn:hover {
      background: #dc2626;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 24px;
      }

      .filter-grid {
        grid-template-columns: 1fr;
      }

      .stats {
        flex-direction: column;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš— Parts Search Results</h1>
      <p>Filter and analyze sell-through rates for climate control parts</p>
    </div>

    <div class="filters">
      <div class="filter-grid">
        <div class="filter-group">
          <label>Search Vehicles</label>
          <input
            type="text"
            id="searchInput"
            placeholder="Search by make, model, or year..."
            oninput="applyFilters()"
          />
        </div>

        <div class="filter-group">
          <label>Sell Through Rate (%)</label>
          <div class="filter-inputs">
            <input type="number" id="minPercentage" placeholder="Min" min="0" max="100">
            <span class="filter-separator">to</span>
            <input type="number" id="maxPercentage" placeholder="Max" min="0" max="100">
          </div>
        </div>

        <div class="filter-group">
          <label>Sold Count</label>
          <div class="filter-inputs">
            <input type="number" id="minSold" placeholder="Min" min="0">
            <span class="filter-separator">to</span>
            <input type="number" id="maxSold" placeholder="Max" min="0">
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="totalResults">0</div>
          <div class="stat-label">Showing Results</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avgPercentage">0%</div>
          <div class="stat-label">Avg Sell Through</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="totalSold">0</div>
          <div class="stat-label">Total Sold</div>
        </div>
      </div>

      <button class="reset-btn" onclick="resetFilters()">Reset Filters</button>
    </div>

    <div class="table-container">
      <div id="loading" class="loading">Loading data...</div>
      <div id="noResults" class="no-results" style="display: none;">
        No results match your filters
      </div>
      <table id="resultsTable" style="display: none;">
        <thead>
          <tr>
            <th onclick="sortTable('searchTerm')">Search Term</th>
            <th onclick="sortTable('percentage')">Sell Through Rate</th>
            <th onclick="sortTable('soldCount')">Sold Count</th>
            <th>Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let sortColumn = 'percentage';
    let sortDirection = 'desc';

    // Load data from external JSON file
    async function loadData() {
      try {
        const response = await fetch('data.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        allData = await response.json();
        filteredData = [...allData];
        applyFilters();
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        document.getElementById('loading').innerHTML = 'Error loading data. Make sure data.json is in the same directory as index.html';
        console.error('Error loading data:', error);
      }
    }

    // Parse search term to extract vehicle info
    function parseSearchTerm(searchTerm) {
      // Format: "YYYY Make Model climate control"
      const parts = searchTerm.split(' ');
      const year = parts[0];
      const lastTwo = parts.slice(-2); // ['climate', 'control']
      const middle = parts.slice(1, -2); // Make and Model
      return {
        year,
        make: middle[0],
        model: middle.slice(1).join(' '),
        fullVehicle: `${middle.join(' ')}`, // Exclude year for grouping
        searchTerm
      };
    }

    // Group data by vehicle
    function groupByVehicle(data) {
      const groups = {};

      data.forEach(item => {
        const parsed = parseSearchTerm(item.searchTerm);
        const key = parsed.fullVehicle;

        if (!groups[key]) {
          groups[key] = {
            vehicle: parsed,
            items: []
          };
        }

        groups[key].items.push(item);
      });

      // Sort items within each group
      Object.values(groups).forEach(group => {
        group.items.sort((a, b) => {
          // Sort by the selected column
          let aVal = a[sortColumn];
          let bVal = b[sortColumn];

          // Handle numeric values
          if (typeof aVal === 'number' && typeof bVal === 'number') {
            return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
          }

          // Handle string values
          if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
          }

          if (sortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });
      });

      // Convert to array and sort by vehicle name
      return Object.values(groups).sort((a, b) =>
        a.vehicle.fullVehicle.localeCompare(b.vehicle.fullVehicle)
      );
    }

    // Get percentage color class
    function getPercentageClass(percentage) {
      if (percentage >= 50) return 'high';
      if (percentage >= 20) return 'medium';
      return 'low';
    }

    // Apply filters
    function applyFilters() {
      const minPercentage = document.getElementById('minPercentage').value;
      const maxPercentage = document.getElementById('maxPercentage').value;
      const minSold = document.getElementById('minSold').value;
      const maxSold = document.getElementById('maxSold').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

      filteredData = allData.filter(item => {
        if (minPercentage !== '' && item.percentage < parseInt(minPercentage)) return false;
        if (maxPercentage !== '' && item.percentage > parseInt(maxPercentage)) return false;
        if (minSold !== '' && item.soldCount < parseInt(minSold)) return false;
        if (maxSold !== '' && item.soldCount > parseInt(maxSold)) return false;

        // Search filter
        if (searchTerm !== '' && !item.searchTerm.toLowerCase().includes(searchTerm)) {
          return false;
        }

        return true;
      });

      renderTable();
      updateStats();
    }

    // Sort data
    function sortData() {
      filteredData.sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];

        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (sortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });
    }

    // Sort table by column
    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'desc';
      }

      // Update header classes
      document.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });

      const headerIndex = ['searchTerm', 'percentage', 'soldCount'].indexOf(column);
      if (headerIndex !== -1) {
        document.querySelectorAll('th')[headerIndex].classList.add(
          sortDirection === 'asc' ? 'sort-asc' : 'sort-desc'
        );
      }

      renderTable();
    }

    // Render table
    function renderTable() {
      const tableBody = document.getElementById('tableBody');
      const table = document.getElementById('resultsTable');
      const noResults = document.getElementById('noResults');

      if (filteredData.length === 0) {
        table.style.display = 'none';
        noResults.style.display = 'block';
        return;
      }

      table.style.display = 'table';
      noResults.style.display = 'none';

      // Sort data before rendering
      filteredData.sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];

        // Handle numeric values
        if (typeof aVal === 'number' && typeof bVal === 'number') {
          return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
        }

        // Handle string values
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (sortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });

      tableBody.innerHTML = filteredData.map(item => `
        <tr onclick="copyToClipboard('${item.searchTerm.replace(/'/g, "\\'")}')">
          <td>${item.searchTerm}</td>
          <td>
            <span class="percentage ${getPercentageClass(item.percentage)}">
              ${item.percentage}%
            </span>
          </td>
          <td>
            <span class="sold-count">${item.soldCount}</span>
          </td>
          <td>
            <input
              type="number"
              class="price-input"
              data-search-term="${item.searchTerm}"
              step="0.01"
              min="0"
              onchange="savePrice(this)"
              onclick="event.stopPropagation()"
            />
          </td>
          <td>
            <button
              class="delete-btn"
              onclick="deletePart('${item.searchTerm.replace(/'/g, "\\'")}', event)"
              title="Delete this entry"
            >
              Delete
            </button>
          </td>
        </tr>
      `).join('');

      // Load saved prices after rendering
      loadPrices();
    }

    // Update statistics
    function updateStats() {
      document.getElementById('totalResults').textContent = filteredData.length;

      if (filteredData.length > 0) {
        const avgPct = Math.round(
          filteredData.reduce((sum, item) => sum + item.percentage, 0) / filteredData.length
        );
        document.getElementById('avgPercentage').textContent = avgPct + '%';

        const totalSold = filteredData.reduce((sum, item) => sum + item.soldCount, 0);
        document.getElementById('totalSold').textContent = totalSold;
      } else {
        document.getElementById('avgPercentage').textContent = '0%';
        document.getElementById('totalSold').textContent = '0';
      }
    }

    // Reset filters
    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('minPercentage').value = '';
      document.getElementById('maxPercentage').value = '';
      document.getElementById('minSold').value = '';
      document.getElementById('maxSold').value = '';
      applyFilters();
    }

    // Save price to localStorage
    function savePrice(input) {
      const searchTerm = input.getAttribute('data-search-term');
      const price = input.value;
      const prices = JSON.parse(localStorage.getItem('partsPrices') || '{}');
      prices[searchTerm] = price;
      localStorage.setItem('partsPrices', JSON.stringify(prices));
    }

    // Load prices from localStorage
    function loadPrices() {
      const prices = JSON.parse(localStorage.getItem('partsPrices') || '{}');
      const inputs = document.querySelectorAll('.price-input');
      inputs.forEach(input => {
        const searchTerm = input.getAttribute('data-search-term');
        if (prices[searchTerm]) {
          input.value = prices[searchTerm];
        }
      });
    }

    // Copy text to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Optional: Show a brief visual feedback
        const originalTitle = document.title;
        document.title = 'âœ“ Copied!';
        setTimeout(() => {
          document.title = originalTitle;
        }, 1000);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    // Delete a part entry
    async function deletePart(searchTerm, event) {
      event.stopPropagation();

      // Confirm deletion
      if (!confirm(`Are you sure you want to delete "${searchTerm}"?`)) {
        return;
      }

      try {
        const response = await fetch('/api/delete-part', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ searchTerm })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete item');
        }

        const result = await response.json();

        // Remove from local data
        allData = allData.filter(item => item.searchTerm !== searchTerm);
        filteredData = filteredData.filter(item => item.searchTerm !== searchTerm);

        // Remove from localStorage prices
        const prices = JSON.parse(localStorage.getItem('partsPrices') || '{}');
        delete prices[searchTerm];
        localStorage.setItem('partsPrices', JSON.stringify(prices));

        // Re-render the table
        renderTable();
        updateStats();

        // Show success message
        const originalTitle = document.title;
        document.title = 'âœ“ Deleted!';
        setTimeout(() => {
          document.title = originalTitle;
        }, 1000);

      } catch (error) {
        console.error('Error deleting item:', error);
        alert(`Failed to delete item: ${error.message}\n\nMake sure the server is running with the updated server.py`);
      }
    }

    // Add event listeners to filter inputs
    document.getElementById('minPercentage').addEventListener('input', applyFilters);
    document.getElementById('maxPercentage').addEventListener('input', applyFilters);
    document.getElementById('minSold').addEventListener('input', applyFilters);
    document.getElementById('maxSold').addEventListener('input', applyFilters);

    // Load data when page loads
    loadData();
  </script>
</body>
</html>
